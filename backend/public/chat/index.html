<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PawCoach ‚Äì Dein KI-Hundetrainer</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #212121;
      color: #ececec;
      height: 100dvh;
      display: flex;
      flex-direction: column;
    }

    /* Top Bar */
    .topbar {
      height: 56px;
      background: #2f2f2f;
      border-bottom: 1px solid #3f3f3f;
      display: flex;
      align-items: center;
      padding: 0 20px;
      gap: 12px;
      flex-shrink: 0;
    }
    .topbar-avatar {
      width: 36px; height: 36px; border-radius: 50%;
      background: #3f3f3f; display: flex; align-items: center;
      justify-content: center; font-size: 20px;
    }
    .topbar-info .topbar-name { font-size: 16px; font-weight: 700; color: #fff; }
    .topbar-info .topbar-sub { font-size: 12px; color: #8e8ea0; }
    .topbar-status {
      margin-left: auto; display: flex; align-items: center; gap: 6px;
      font-size: 12px; color: #10a37f;
    }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #10a37f; }

    /* Chat Area */
    .chat-area {
      flex: 1;
      overflow-y: auto;
      padding: 24px 0;
      scroll-behavior: smooth;
    }

    .welcome-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      gap: 16px;
      text-align: center;
      padding: 32px;
    }
    .welcome-avatar { font-size: 64px; }
    .welcome-title { font-size: 24px; font-weight: 700; }
    .welcome-name { font-size: 16px; color: #10a37f; font-weight: 600; }
    .welcome-sub { color: #8e8ea0; font-size: 14px; max-width: 400px; line-height: 1.6; }
    .suggestion-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      max-width: 480px;
      width: 100%;
      margin-top: 8px;
    }
    .suggestion-btn {
      background: #2f2f2f;
      border: 1px solid #3f3f3f;
      border-radius: 10px;
      padding: 12px 14px;
      color: #ececec;
      font-size: 13px;
      cursor: pointer;
      text-align: left;
      transition: all 0.2s;
      line-height: 1.4;
    }
    .suggestion-btn:hover { background: #3f3f3f; border-color: #10a37f; }

    /* Messages */
    .message-wrapper {
      max-width: 760px;
      margin: 0 auto;
      padding: 0 24px;
    }
    .message {
      display: flex;
      gap: 14px;
      padding: 16px 0;
      border-bottom: 1px solid #2a2a2a;
    }
    .message:last-child { border-bottom: none; }
    .message-avatar {
      width: 32px; height: 32px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 16px; flex-shrink: 0; margin-top: 2px;
    }
    .message.user .message-avatar { background: #10a37f; color: #fff; font-size: 13px; font-weight: 700; }
    .message.assistant .message-avatar { background: #2f2f2f; border: 1px solid #3f3f3f; }
    .message-body { flex: 1; min-width: 0; }
    .message-name { font-size: 12px; font-weight: 600; color: #8e8ea0; margin-bottom: 6px; }
    .message-content { font-size: 15px; line-height: 1.75; color: #d1d5db; white-space: pre-wrap; word-wrap: break-word; }
    .message.user .message-content { color: #ececec; }

    /* Typing indicator */
    .typing-indicator { display: flex; gap: 4px; align-items: center; padding: 4px 0; }
    .typing-indicator span {
      width: 7px; height: 7px; background: #8e8ea0;
      border-radius: 50%; animation: bounce 1.2s infinite;
    }
    .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
    .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes bounce { 0%,80%,100%{transform:translateY(0)} 40%{transform:translateY(-6px)} }

    /* Input Area */
    .input-area { background: #212121; padding: 16px 24px 20px; flex-shrink: 0; }
    .input-wrapper {
      max-width: 760px; margin: 0 auto;
      background: #2f2f2f; border: 1px solid #3f3f3f; border-radius: 14px;
      display: flex; align-items: flex-end; gap: 8px; padding: 10px 12px 10px 16px;
      transition: border-color 0.2s;
    }
    .input-wrapper:focus-within { border-color: #10a37f; }
    textarea#msgInput {
      flex: 1; background: transparent; border: none; outline: none;
      color: #ececec; font-size: 15px; font-family: inherit;
      resize: none; max-height: 160px; min-height: 24px; line-height: 1.6;
    }
    textarea#msgInput::placeholder { color: #6e6e80; }
    .send-btn {
      width: 36px; height: 36px; background: #10a37f; border: none; border-radius: 8px;
      cursor: pointer; display: flex; align-items: center; justify-content: center;
      transition: all 0.2s; flex-shrink: 0;
    }
    .send-btn:disabled { background: #3f3f3f; cursor: not-allowed; }
    .send-btn svg { width: 16px; height: 16px; fill: #fff; }
    .input-hint { text-align: center; font-size: 11px; color: #6e6e80; margin-top: 8px; }

    /* Scrollbar */
    .chat-area::-webkit-scrollbar { width: 6px; }
    .chat-area::-webkit-scrollbar-track { background: transparent; }
    .chat-area::-webkit-scrollbar-thumb { background: #3f3f3f; border-radius: 3px; }
  </style>
</head>
<body>

<div class="topbar">
  <div class="topbar-avatar" id="topbarAvatar">üêï</div>
  <div class="topbar-info">
    <div class="topbar-name" id="topbarName">PawCoach</div>
    <div class="topbar-sub" id="topbarSub">KI-Hundetrainer</div>
  </div>
  <div class="topbar-status">
    <div class="status-dot"></div>
    Online
  </div>
</div>

<div class="chat-area" id="chatArea">
  <div class="welcome-screen" id="welcomeScreen">
    <div class="welcome-avatar" id="welcomeAvatar">üêï</div>
    <div class="welcome-name" id="welcomeName">Lade‚Ä¶</div>
    <div class="welcome-title">Wie kann ich dir helfen?</div>
    <div class="welcome-sub" id="welcomeSub">Stell mir deine Frage zur Hundeerziehung!</div>
    <div class="suggestion-grid" id="suggestionGrid">
      <button class="suggestion-btn" onclick="suggest(this)">Mein Hund zieht stark an der Leine. Was tun?</button>
      <button class="suggestion-btn" onclick="suggest(this)">Wie trainiere ich meinen Welpen mit Clicker?</button>
      <button class="suggestion-btn" onclick="suggest(this)">Mein Hund bellt st√§ndig fremde Menschen an.</button>
      <button class="suggestion-btn" onclick="suggest(this)">Wie oft sollte ich meinen Hund t√§glich trainieren?</button>
    </div>
  </div>
  <div class="message-wrapper" id="messageList" style="display:none"></div>
</div>

<div class="input-area">
  <div class="input-wrapper">
    <textarea id="msgInput" placeholder="Stell deine Frage‚Ä¶" rows="1"></textarea>
    <button class="send-btn" id="sendBtn" disabled onclick="sendMessage()">
      <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
    </button>
  </div>
  <div class="input-hint">PawCoach nutzt KI ‚Äì kein Ersatz f√ºr professionelle Beratung vor Ort.</div>
</div>

<script>
  let trainer = null;
  let history = [];
  let isLoading = false;

  // Trainer-Info laden
  fetch('/api/trainer')
    .then(r => r.json())
    .then(t => {
      trainer = t;
      document.getElementById('topbarAvatar').textContent = t.avatar || 'üêï';
      document.getElementById('topbarName').textContent = t.name;
      document.getElementById('topbarSub').textContent = t.specialty;
      document.getElementById('welcomeAvatar').textContent = t.avatar || 'üêï';
      document.getElementById('welcomeName').textContent = t.name;
      document.getElementById('welcomeSub').textContent =
        `Hallo! Ich bin ${t.name}. Stell mir deine Fragen rund um Hundeerziehung!`;
    });

  function suggest(btn) {
    document.getElementById('msgInput').value = btn.textContent;
    autoResize();
    sendMessage();
  }

  const textarea = document.getElementById('msgInput');
  function autoResize() {
    textarea.style.height = 'auto';
    textarea.style.height = Math.min(textarea.scrollHeight, 160) + 'px';
    document.getElementById('sendBtn').disabled = !textarea.value.trim() || isLoading;
  }
  textarea.addEventListener('input', autoResize);
  textarea.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
  });

  function appendMessage(role, content) {
    const list = document.getElementById('messageList');
    document.getElementById('welcomeScreen').style.display = 'none';
    list.style.display = 'block';

    const div = document.createElement('div');
    div.className = `message ${role}`;
    div.innerHTML = `
      <div class="message-avatar">${role === 'user' ? 'Du' : (trainer?.avatar || 'üêï')}</div>
      <div class="message-body">
        <div class="message-name">${role === 'user' ? 'Du' : (trainer?.name || 'Trainer')}</div>
        <div class="message-content"></div>
      </div>`;
    list.appendChild(div);
    scrollDown();
    return div.querySelector('.message-content');
  }

  function scrollDown() {
    const area = document.getElementById('chatArea');
    setTimeout(() => area.scrollTo({ top: area.scrollHeight, behavior: 'smooth' }), 50);
  }

  async function sendMessage() {
    const text = textarea.value.trim();
    if (!text || isLoading) return;

    isLoading = true;
    textarea.value = '';
    textarea.style.height = 'auto';
    document.getElementById('sendBtn').disabled = true;

    appendMessage('user', text);
    history.push({ role: 'user', content: text });

    const contentEl = appendMessage('assistant', '');
    contentEl.innerHTML = '<div class="typing-indicator"><span></span><span></span><span></span></div>';

    let fullText = '';
    let firstChunk = true;

    try {
      const response = await fetch('/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: text, history: history.slice(-10) }),
      });

      const reader = response.body.getReader();
      const decoder = new TextDecoder();

      while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        const lines = decoder.decode(value).split('\n');
        for (const line of lines) {
          if (!line.startsWith('data: ')) continue;
          const data = line.slice(6);
          if (data === '[DONE]') break;
          try {
            const { text: chunk } = JSON.parse(data);
            if (firstChunk) { contentEl.textContent = ''; firstChunk = false; }
            fullText += chunk;
            contentEl.textContent = fullText;
            scrollDown();
          } catch {}
        }
      }
    } catch {
      contentEl.textContent = 'Verbindungsfehler. Bitte versuche es erneut.';
    }

    history.push({ role: 'assistant', content: fullText });
    isLoading = false;
    document.getElementById('sendBtn').disabled = false;
    textarea.focus();
  }
</script>
</body>
</html>
